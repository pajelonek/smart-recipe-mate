---
import { UpdatePasswordForm } from "@/components/auth/UpdatePasswordForm";
import PublicLayout from "@/layouts/PublicLayout.astro";
import { createServerSupabaseClient } from "@/db/supabase.client";

const supabase = createServerSupabaseClient(Astro);
const searchParams = Astro.url.searchParams;

const errorParam = searchParams.get("error");
if (errorParam) {
  return Astro.redirect(`/login?error=${encodeURIComponent(errorParam)}`);
}

const code = searchParams.get("code");
const accessToken = searchParams.get("access_token");
const refreshToken = searchParams.get("refresh_token");

if (code) {
  const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);

  if (exchangeError) {
    console.error("Error exchanging recovery code for session:", exchangeError);
    return Astro.redirect("/login?error=session_error");
  }

  return Astro.redirect("/auth/update-password");
}

if (accessToken && refreshToken) {
  const { error: setSessionError } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (setSessionError) {
    console.error("Error establishing recovery session:", setSessionError);
    return Astro.redirect("/login?error=session_error");
  }

  return Astro.redirect("/auth/update-password");
}

const {
  data: { session },
} = await supabase.auth.getSession();

const hasSession = Boolean(session);
---

<script is:inline>
  declare global {
    interface Window {
      supabaseSession?: {
        access_token?: string;
      };
    }
  }

  if (typeof window !== "undefined" && window.location.hash.length > 1) {
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const allowedKeys = new Set(["access_token", "refresh_token", "expires_in", "token_type", "type", "code"]);
    const hasRelevantKey = Array.from(hashParams.keys()).some((key) => allowedKeys.has(key));

    if (hasRelevantKey) {
      const url = new URL(window.location.href);
      let updated = false;

      hashParams.forEach((value, key) => {
        if (!allowedKeys.has(key) || !value) {
          return;
        }

        if (key === "access_token") {
          window.supabaseSession = window.supabaseSession || {};
          window.supabaseSession.access_token = value;
        }

        if (url.searchParams.get(key) !== value) {
          url.searchParams.set(key, value);
          updated = true;
        }
      });

      if (updated) {
        const search = url.searchParams.toString();
        const nextUrl = search ? `${url.pathname}?${search}` : url.pathname;
        window.location.replace(nextUrl);
      } else {
        window.location.replace(url.pathname);
      }
    }
  }
</script>

<PublicLayout title="Zmień hasło">
  <UpdatePasswordForm client:load hasSession={hasSession} />
</PublicLayout>
