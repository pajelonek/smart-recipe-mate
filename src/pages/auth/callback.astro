---
import { createServerSupabaseClient } from "../../db/supabase.client";

const supabase = createServerSupabaseClient(Astro);

const code = Astro.url.searchParams.get("code");
const next = Astro.url.searchParams.get("next") || "/";

if (Astro.url.searchParams.get("error")) {
  return Astro.redirect("/login?error=auth_callback_failed");
}

if (!code) {
  return Astro.redirect("/login");
}

const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);

if (exchangeError) {
  console.error("Error exchanging code for session:", exchangeError);
  return Astro.redirect("/login?error=session_error");
}

const {
  data: { user },
  error: userError,
} = await supabase.auth.getUser();

if (userError || !user) {
  return Astro.redirect("/login?error=user_not_found");
}

const { data: preferences } = await supabase
  .from("user_preferences")
  .select("user_id")
  .eq("user_id", user.id)
  .maybeSingle();

if (!preferences) {
  return Astro.redirect("/onboarding");
}

return Astro.redirect(next);
---
