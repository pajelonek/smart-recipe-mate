---

import Layout from "../layouts/Layout.astro";
import { DashboardContent } from "../components/dashboard/DashboardContent";
import { createServerSupabaseClient } from "../db/supabase.client";
import { getUserRecipes } from "../lib/services/recipes.service";
import type { UserStats, Recipe } from "../types";
import { ModeToggle } from "../components/common/ModeToggle";
import { Button } from "../components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "../components/ui/card";

const supabase = createServerSupabaseClient(Astro);

// Get authenticated user from session
const { data: { session }, error: authError } = await supabase.auth.getSession();
const user = session?.user || null;

// Initialize variables for authenticated users
let recentRecipes: Recipe[] = [];
let stats: UserStats = { recipesCount: 0, generationsCount: 0 };
let userName = "User";

// If authenticated, fetch user data
if (user !== null) {
  const userId: string = user.id;
  
  // Check if user has completed onboarding (has preferences)
  const { data: preferences } = await supabase
    .from('user_preferences')
    .select('user_id')
    .eq('user_id', userId)
    .maybeSingle();
  if (!preferences) {
    return Astro.redirect('/onboarding');
  }

  // Fetch recipes
  const recipes = await getUserRecipes(userId, supabase);
  recentRecipes = recipes.slice(0, 10);

  // Fetch stats
  const { count: recipesCount, error: recipesError } = await supabase
    .from("recipes")
    .select("*", { count: "exact", head: true })
    .eq("owner_id", userId)
    .is("deleted_at", null);

  if (recipesError) {
    console.error("Error fetching recipes count:", recipesError);
    return Astro.response(new Response("Internal Server Error", { status: 500 }));
  }

  const { count: generationsCount, error: generationsError } = await supabase
    .from("ai_generations")
    .select("*", { count: "exact", head: true })
    .eq("user_id", userId);

  if (generationsError) {
    console.error("Error fetching generations count:", generationsError);
    return Astro.response(new Response("Internal Server Error", { status: 500 }));
  }

  stats = {
    recipesCount: recipesCount || 0,
    generationsCount: generationsCount || 0,
  };

   
  userName = user.user_metadata?.display_name || user.email?.split("@")[0] || "User";
}
---
<>
{!user && (
  <Layout title="Dopasuj przepisy do swoich potrzeb">
    <div class="bg-background flex flex-col">
      <!-- Header with Theme Toggle and Login Button -->
      <header class="border-b border-border">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
          <h1 class="text-2xl font-bold">Smart Recipe Mate</h1>
          <div class="flex items-center gap-4">
            <ModeToggle client:load />
            <Button asChild>
              <a href="/login">Zaloguj się</a>
            </Button>
          </div>
        </div>
      </header>

      <!-- Hero Section -->
      <main class="flex-1 flex items-center justify-center p-6 mt-24">
        <div class="max-w-4xl w-full space-y-12">
          <!-- Main Hero -->
          <div class="text-center space-y-6">
            <h2 class="text-5xl font-bold tracking-tight">
              Dopasuj przepisy do swoich potrzeb
            </h2>
            <p class="text-xl text-muted-foreground max-w-2xl mx-auto pt-4">
              Smart Recipe Mate wykorzystuje AI do tworzenia i znajdowania przepisów kulinarnych 
              dopasowanych do Twoich preferencji żywieniowych i dostępnych produktów.
            </p>
            <div class="flex gap-4 justify-center pt-6">
              <Button size="lg">
                <a href="/register">Rozpocznij za darmo</a>
              </Button>
              <Button variant="outline" size="lg">
                <a href="/login">Mam już konto</a>
              </Button>
            </div>
          </div>

          <!-- Features -->
          <div class="grid md:grid-cols-3 gap-6 pt-8">
            <Card>
              <CardHeader>
                <CardTitle>Preferencje żywieniowe</CardTitle>
                <CardDescription>
                  Zapisz swoje wymagania dietetyczne i preferencje smakowe
                </CardDescription>
              </CardHeader>
            </Card>
            <Card>
              <CardHeader>
                <CardTitle>Generowanie przepisów AI</CardTitle>
                <CardDescription>
                  Twórz przepisy na podstawie dostępnych produktów i swoich preferencji
                </CardDescription>
              </CardHeader>
            </Card>
            <Card>
              <CardHeader>
                <CardTitle>Repozytorium przepisów</CardTitle>
                <CardDescription>
                  Zarządzaj swoimi ulubionymi przepisami w jednym miejscu
                </CardDescription>
              </CardHeader>
            </Card>
          </div>
        </div>
      </main>
    </div>
  </Layout>
)}

{user && (
  <Layout title="Dashboard - Smart Recipe Mate">
    <DashboardContent
      client:load
      initialRecipes={recentRecipes}
      initialStats={stats}
      userName={userName}
      sessionToken="dev-session-token"
    />
  </Layout>
)}
</>
