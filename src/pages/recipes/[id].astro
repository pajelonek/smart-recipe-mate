---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { createServerSupabaseClient } from "../../db/supabase.client";
import { RecipeDetailContent } from "../../components/recipes/edit/RecipeDetailContent";
import { getRecipeById } from "../../lib/services/recipes.service";
import type { Recipe } from "../../types";

const supabase = createServerSupabaseClient(Astro);
const recipeId = Astro.params.id;

if (!recipeId) {
  return Astro.redirect("/recipes?error=invalid_id");
}

// Get authenticated user from session
const {
  data: { session },
} = await supabase.auth.getSession();
const user = session?.user || null;

// Redirect to login if not authenticated
if (!user) {
  return Astro.redirect("/login?redirect=" + encodeURIComponent(Astro.url.pathname));
}

const userId: string = user.id;

// Check if user has completed onboarding (has preferences)
const { data: preferences } = await supabase
  .from("user_preferences")
  .select("user_id")
  .eq("user_id", userId)
  .maybeSingle();

if (!preferences) {
  return Astro.redirect("/onboarding");
}

// Fetch recipe from database
const recipe = await getRecipeById(recipeId, userId, supabase);

// If recipe not found, redirect to recipes list with error
if (!recipe) {
  return Astro.redirect("/recipes?error=not_found");
}

// Get access token for client-side API calls
const accessToken = session?.access_token || "";

// Get user name for display
const userName = user.user_metadata?.display_name || user.email?.split("@")[0] || "User";
const pageTitle = `${recipe.title} - Smart Recipe Mate`;
---

<AuthLayout pageTitle={pageTitle} userName={userName}>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <RecipeDetailContent client:load recipeId={recipeId} initialRecipe={recipe} accessToken={accessToken} />
  </div>
</AuthLayout>
