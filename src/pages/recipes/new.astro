---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { createServerSupabaseClient } from "../../db/supabase.client";
import { NewRecipeForm } from "../../components/recipes/new/NewRecipeForm";

const supabase = createServerSupabaseClient(Astro);

const {
  data: { session },
} = await supabase.auth.getSession();
const user = session?.user || null;

if (!user) {
  return Astro.redirect("/login");
}

const userId: string = user.id;
const { data: preferences } = await supabase
  .from("user_preferences")
  .select("user_id")
  .eq("user_id", userId)
  .maybeSingle();

if (!preferences) {
  return Astro.redirect("/onboarding");
}

const userName = user.user_metadata?.display_name || user.email?.split("@")[0] || "User";
const pageTitle = "Nowy przepis - Smart Recipe Mate";
---

<AuthLayout pageTitle={pageTitle} userName={userName}>
  <NewRecipeForm client:load />
</AuthLayout>
